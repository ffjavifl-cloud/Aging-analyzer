<!-- PEGAR en WordPress en Bloque "HTML Personalizado" -->
<div id="aging-analyzer" style="max-width:680px;margin:0 auto;font-family:Arial,Helvetica,sans-serif;">
  <h2 style="margin-bottom:6px;">Analizador de piel (foto móvil)</h2>
  <p style="margin-top:0;color:#555;font-size:0.95em;">Toma o selecciona una foto que muestre cara y escote. Respeta la privacidad: usa solo imágenes con consentimiento.</p>

  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <input id="aa-file" type="file" accept="image/*" capture="environment" style="flex:1" />
    <button id="aa-send" style="padding:8px 12px;background:#0066cc;color:#fff;border:none;border-radius:6px;cursor:pointer;" disabled>Analizar</button>
  </div>

  <img id="aa-preview" src="" alt="preview" style="display:block;width:100%;max-height:420px;object-fit:contain;margin-top:12px;border:1px solid #eee;border-radius:6px;"/>

  <div id="aa-status" style="margin-top:10px;color:#333;font-size:0.95em;"></div>

  <div id="aa-results" style="margin-top:12px;padding:10px;border-radius:6px;background:#f8f9fb;border:1px solid #eef2f7;display:none;"></div>
</div>

<script>
(function(){
  // ---- CAMBIA ESTA LÍNEA: pega la URL de tu servidor desplegado en Render ----
  const SERVER_URL = "https://TU-SERVIDOR.onrender.com/analyze"; // ejemplo: https://mi-servidor.onrender.com/analyze

  const fileInput = document.getElementById('aa-file')
  const preview = document.getElementById('aa-preview')
  const sendBtn = document.getElementById('aa-send')
  const status = document.getElementById('aa-status')
  const resultsDiv = document.getElementById('aa-results')

  function renderResults(json) {
    if (!json) return '<p>No hay resultados</p>'
    if (json.error) return '<p style="color:#b00">Error: ' + json.error + '</p>'
    const map = [
      ['elasticity','Elasticidad (0-100, 100 mejor)'],
      ['wrinkles_general','Arrugas generales (0-100)'],
      ['wrinkles_deep','Arrugas profundas (0-100)'],
      ['expression_lines','Líneas de expresión (0-100)'],
      ['pigmentation','Pigmentación / manchas (0-100)'],
      ['age_biological','Edad biológica estimada']
    ]
    let html = '<ul style="padding-left:18px;margin:0;">'
    map.forEach(([k,label])=>{
      if (k in json && json[k] !== null && json[k] !== undefined) {
        html += `<li><strong>${label}:</strong> ${json[k]}</li>`
      }
    })
    html += '</ul>'
    if (json.debug) {
      html += '<details style="margin-top:8px;font-size:0.9em;"><summary>Información técnica (debug)</summary><pre style="white-space:pre-wrap">'+ JSON.stringify(json.debug, null, 2) +'</pre></details>'
    }
    return html
  }

  fileInput.addEventListener('change', () => {
    const f = fileInput.files[0]
    if (!f) { preview.src = ''; sendBtn.disabled = true; return }
    sendBtn.disabled = false
    preview.src = URL.createObjectURL(f)
    resultsDiv.style.display = 'none'
    status.textContent = ''
  })

  sendBtn.addEventListener('click', async () => {
    const f = fileInput.files[0]
    if (!f) return
    if (!SERVER_URL || SERVER_URL.includes('TU-SERVIDOR')) { alert('Configura SERVER_URL en el código con la URL de tu servidor antes de usar.'); return }

    sendBtn.disabled = true
    status.style.color = '#333'
    status.textContent = 'Subiendo imagen y procesando...'
    resultsDiv.style.display = 'none'
    try {
      const form = new FormData()
      form.append('file', f)
      const resp = await fetch(SERVER_URL, {
        method: 'POST',
        body: form
      })
      if (!resp.ok) {
        const text = await resp.text()
        status.style.color = '#b00'
        status.textContent = 'Error del servidor: ' + resp.status + ' — ' + text
        sendBtn.disabled = false
        return
      }
      const json = await resp.json()
      resultsDiv.innerHTML = renderResults(json)
      resultsDiv.style.display = 'block'
      status.style.color = '#080'
      status.textContent = 'Análisis completo'
    } catch (err) {
      console.error(err)
      status.style.color = '#b00'
      status.textContent = 'Error de red: ' + err.toString()
    } finally {
      sendBtn.disabled = false
    }
  })
})();
</script>
